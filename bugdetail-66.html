<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: support for insertable/updatable</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="imario">
<meta name="description" content="This patch will take the insertable updatable flag on JoinColumn into account With this patch it is possible to have associations in your entity which are not persisted Index ebean src com avaje ebean server deploy parse JoinDefineManualInfo java ebean src com avaje ebean server deploy parse JoinDefineManualInfo java revision 127 ebean src com avaje ebean server deploy parse JoinDefineManualInfo java Sat Feb 14 16 25 31 CET 2009 152 7 152 7 String localColumn nullEmptyString joinColumn name String refColumn nullEmptyString joinColumn referencedColumnName add new DeployTableJoinColumn localColumn refColumn add new DeployTableJoinColumn localColumn refColumn joinColumn insertable joinColumn updatable private String nullEmptyString String s Index ebean src com avaje ebean server deploy BeanPr">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-66.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 66 : support for insertable/updatable
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 66 : support for insertable/updatable </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">imario</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">1.0.3</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">14/02/2009</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">14/02/2009</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>This patch will take the insertable/updatable flag on JoinColumn into account.</p><p>With this patch it is possible to have associations in your entity which are not persisted.</p><p>Index: ../ebean/src/com/avaje/ebean/server/deploy/parse/JoinDefineManualInfo.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/parse/JoinDefineManualInfo.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/parse/JoinDefineManualInfo.java	Sat Feb 14 16:25:31 CET 2009<br/>@@ -152,7 +152,7 @@<br/> 		String localColumn = nullEmptyString(joinColumn.name());<br/> 		String refColumn = nullEmptyString(joinColumn.referencedColumnName());<br/> 		<br/>-		add(new DeployTableJoinColumn(localColumn, refColumn));<br/>+		add(new DeployTableJoinColumn(localColumn, refColumn, joinColumn.insertable(), joinColumn.updatable()));<br/> 	}<br/> 	<br/> 	private String nullEmptyString(String s){<br/>Index: ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssoc.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssoc.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssoc.java	Sat Feb 14 16:35:14 CET 2009<br/>@@ -217,6 +217,23 @@<br/> 		return tableJoin;<br/> 	}<br/> <br/>+    public boolean isUpdateable() {<br/>+        if (tableJoin.columns().length > 0) {<br/>+            return tableJoin.columns()[0].isUpdatable();<br/>+        }<br/>+<br/>+        return true;<br/>+    }<br/>+<br/>+    public boolean isInsertable() {<br/>+        if (tableJoin.columns().length > 0) {<br/>+            return tableJoin.columns()[0].isInsertable();<br/>+        }<br/>+<br/>+        return true;<br/>+    }<br/>+<br/>+<br/> 	/**<br/> 	 * Return the BeanTable for this association.<br/> 	 * <p><br/>@@ -264,6 +281,11 @@<br/> 			} else {<br/> 				// embedded id<br/> 				BeanPropertyAssocOne embProp = (BeanPropertyAssocOne)props[0];<br/>+                if (embProp.getTargetDescriptor() == null)<br/>+                {<br/>+                    // I'll consider this as a hack ...<br/>+                    embProp.initialise();<br/>+                }<br/> 				BeanProperty[] embBaseProps = embProp.getTargetDescriptor().propertiesBaseScalar();<br/> 				ImportedIdSimple[] scalars = createImportedList(owner, cols, embBaseProps);<br/> 				<br/>Index: ../ebean/src/com/avaje/ebean/server/persist/dmlbind/FactoryAssocOnes.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/persist/dmlbind/FactoryAssocOnes.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/persist/dmlbind/FactoryAssocOnes.java	Sat Feb 14 16:37:08 CET 2009<br/>@@ -23,6 +23,7 @@<br/> <br/> import com.avaje.ebean.server.deploy.BeanDescriptor;<br/> import com.avaje.ebean.server.deploy.BeanPropertyAssocOne;<br/>+import com.avaje.ebean.server.persist.dml.Modes;<br/> <br/> /**<br/>  * A factory that builds Bindable for BeanPropertyAssocOne properties.<br/>@@ -35,7 +36,7 @@<br/> 	/**<br/> 	 * Add foreign key columns from associated one beans.<br/> 	 */<br/>-	public List<Bindable> create(List<Bindable> list, BeanDescriptor desc) {<br/>+	public List<Bindable> create(List<Bindable> list, BeanDescriptor desc, int mode) {<br/> <br/> 		BeanPropertyAssocOne[] ones = desc.propertiesOneImported();<br/> <br/>@@ -47,8 +48,21 @@<br/> 				// excluded as its the 'non-owning' side of OneToOne<br/> <br/> 			} else {<br/>+                switch(mode)<br/>+                {<br/>+                    case Modes.MODE_INSERT:<br/>+                        if (!ones[i].isInsertable()) {<br/>+                            continue;<br/>+                        }<br/>+                        break;<br/>+                    case Modes.MODE_UPDATE:<br/>+                        if (!ones[i].isUpdateable()) {<br/>+                            continue;<br/>+                        }<br/>+                        break;<br/>+                }<br/>-				Bindable item = new BindableAssocOne(ones[i]);<br/>-				list.add(item);<br/>+                Bindable item = new BindableAssocOne(ones[i]);<br/>+                list.add(item);<br/> 			}<br/> 		}<br/> <br/>Index: ../ebean/src/com/avaje/ebean/server/deploy/TableJoinColumn.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/TableJoinColumn.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/TableJoinColumn.java	Sat Feb 14 16:08:47 CET 2009<br/>@@ -36,17 +36,24 @@<br/>      */<br/>     private final String foreignDbColumn;<br/> <br/>+    private final boolean updatable;<br/>+<br/>+    private final boolean insertable;<br/>     /**<br/>      * Create the pair.<br/>      */<br/>     public TableJoinColumn(DeployTableJoinColumn deploy) {<br/>     	this.localDbColumn = deploy.getLocalDbColumn();<br/>     	this.foreignDbColumn = deploy.getForeignDbColumn();<br/>+        this.updatable = deploy.isUpdatable();<br/>+        this.insertable = deploy.isInsertable();<br/>     }<br/>     <br/>     public TableJoinColumn(String localDbColumn, String foreignDbColumn) {<br/>     	this.localDbColumn = localDbColumn;<br/>     	this.foreignDbColumn = foreignDbColumn;<br/>+        this.updatable = true;<br/>+        this.insertable = true;<br/>     }<br/>     <br/> //    /**<br/>@@ -75,4 +82,11 @@<br/>         return localDbColumn;<br/>     }<br/> <br/>+    public boolean isUpdatable() {<br/>+        return updatable;<br/>-}<br/>+    }<br/>+<br/>+    public boolean isInsertable() {<br/>+        return insertable;<br/>+    }<br/>+}<br/>Index: ../ebean/src/com/avaje/ebean/server/persist/dml/MetaFactory.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/persist/dml/MetaFactory.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/persist/dml/MetaFactory.java	Sat Feb 14 16:18:28 CET 2009<br/>@@ -71,7 +71,7 @@<br/> <br/> 		baseFact.create(setList, desc, MODE_UPDATE, includeLobs);<br/> 		embeddedFact.create(setList, desc, MODE_UPDATE, includeLobs);<br/>-		assocOneFact.create(setList, desc);<br/>+		assocOneFact.create(setList, desc, MODE_UPDATE);<br/> <br/> 		Bindable id = idFact.createId(desc);<br/> <br/>@@ -82,7 +82,7 @@<br/> <br/> 		baseFact.create(allList, desc, MODE_WHERE, false);<br/> 		embeddedFact.create(allList, desc, MODE_WHERE, false);<br/>-		assocOneFact.create(allList, desc);<br/>+		assocOneFact.create(allList, desc, MODE_WHERE);<br/> 		<br/> 		<br/> 		Bindable setBindable = new BindableList(setList);<br/>@@ -104,7 +104,7 @@<br/> 		<br/> 		baseFact.create(allList, desc, MODE_WHERE, false);<br/> 		embeddedFact.create(allList, desc, MODE_WHERE, false);<br/>-		assocOneFact.create(allList, desc);<br/>+		assocOneFact.create(allList, desc, MODE_WHERE);<br/> <br/> 		Bindable allBindable = new BindableList(allList);<br/> 		<br/>@@ -122,7 +122,7 @@<br/> <br/> 		baseFact.create(allList, desc, MODE_INSERT, includeLobs);<br/> 		embeddedFact.create(allList, desc, MODE_INSERT, includeLobs);<br/>-		assocOneFact.create(allList, desc);<br/>+		assocOneFact.create(allList, desc, MODE_INSERT);<br/> <br/> 		Bindable allBindable = new BindableList(allList);<br/> 		<br/>Index: ../ebean/src/com/avaje/ebean/server/deploy/meta/DeployTableJoinColumn.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/meta/DeployTableJoinColumn.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/meta/DeployTableJoinColumn.java	Sat Feb 14 16:08:47 CET 2009<br/>@@ -34,6 +34,9 @@<br/> 	 */<br/> 	String foreignDbColumn;<br/> <br/>+    boolean insertable;<br/>+    boolean updatable;<br/>+<br/> 	// /**<br/> 	// * Create the pair.<br/> 	// */<br/>@@ -41,16 +44,19 @@<br/> 	//<br/> 	// }<br/> <br/>-	public DeployTableJoinColumn(String localDbColumn, String foreignDbColumn) {<br/>+	public DeployTableJoinColumn(String localDbColumn, String foreignDbColumn, boolean insertable, boolean updatable) {<br/> 		this.localDbColumn = localDbColumn;<br/> 		this.foreignDbColumn = foreignDbColumn;<br/>+        this.insertable = insertable;<br/>+        this.updatable = updatable;<br/> 	}<br/> <br/> 	/**<br/> 	 * Create a TableJoinColumn with the local and foreign columns swapped.<br/> 	 */<br/> 	public DeployTableJoinColumn createInverse() {<br/>-		return new DeployTableJoinColumn(foreignDbColumn, localDbColumn);<br/>+        // TODO: do we really know that the inverse join is has the same insertable/updatable state?<br/>+		return new DeployTableJoinColumn(foreignDbColumn, localDbColumn, insertable, updatable);<br/> 	}<br/> <br/> 	public String toString() {<br/>@@ -120,4 +126,11 @@<br/> 		this.localDbColumn = localDbColumn;<br/> 	}<br/> <br/>+    public boolean isInsertable() {<br/>+        return insertable;<br/>-}<br/>+    }<br/>+<br/>+    public boolean isUpdatable() {<br/>+        return updatable;<br/>+    }<br/>+}<br/>Index: ../ebean/src/com/avaje/ebean/server/deploy/meta/DeployTableJoin.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/meta/DeployTableJoin.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/meta/DeployTableJoin.java	Sat Feb 14 16:07:37 CET 2009<br/>@@ -131,9 +131,9 @@<br/> 			DeployTableJoinColumn joinColumn;<br/> 			if (exported) {<br/> 				// its around the other way...<br/>-				joinColumn = new DeployTableJoinColumn(col.getPkColumnName(), col.getFkColumnName());<br/>+				joinColumn = new DeployTableJoinColumn(col.getPkColumnName(), col.getFkColumnName(), true, true);<br/> 			} else {<br/>-				joinColumn = new DeployTableJoinColumn(col.getFkColumnName(), col.getPkColumnName());<br/>+				joinColumn = new DeployTableJoinColumn(col.getFkColumnName(), col.getPkColumnName(), true, true);<br/> 			}<br/> 	<br/> 			addTableJoinColumn(joinColumn);<br/>Index: ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssocMany.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssocMany.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssocMany.java	Sat Feb 14 10:37:23 CET 2009<br/>@@ -310,6 +310,11 @@<br/> 		if (uids.length == 1 && uids[0].isEmbedded()) {<br/> <br/> 			BeanPropertyAssocOne one = (BeanPropertyAssocOne) uids[0];<br/>+            if (one.getTargetDescriptor() == null)<br/>+            {<br/>+                // I'll consider this as a hack ...<br/>+                one.initialise();<br/>+            }<br/> 			BeanDescriptor targetDesc = one.getTargetDescriptor();<br/> 			BeanProperty[] emIds = targetDesc.propertiesBaseScalar();<br/> 			for (int i = 0; i < emIds.length; i++) {</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
imario 
14 Feb&nbsp;15:47
</div>
test
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>I do have a simple test for this which I can send you as zip if you would like to</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
16 Feb&nbsp;10:03
</div>
Looks good.
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>This looks good...</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Feb&nbsp;08:39
</div>
Related to 67
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Note this is related to 67 - which provides column alias' ... which is required when you have multiple associations and concatenated keys.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Feb&nbsp;11:07
</div>
Convert from ENH to BUG
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>I'm going to convert this from an ENH to a BUG.</p><p>I'm happy with all the changes detailed here (except for the hack part)...<br/>+ // I'll consider this as a hack ...<br/>+ one.initialise();)</p><p>Note: I have fixed the hack part ... by doing a 2 phase initialisation of the BeanDescriptors. The first phase initialising the ID properties and the second phase initialising the rest (this was needed as the associated properties required the target descriptors from the ID properties).</p><p>I tested this all against H2... so just need to commit it into svn.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
18 Feb&nbsp;10:31
</div>
Fixed in v1.0.3
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Thanks Mario - great work.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="66">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-66.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="66">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
