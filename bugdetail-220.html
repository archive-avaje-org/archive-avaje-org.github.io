<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: M2M cascade save ... violates foreign key constraint </title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="Rob">
<meta name="description" content="user Ebean find User class 1462 Role role1 new Role role1 setName role1 Ebean save role1 Role role2 new Role role2 setName role2 Ebean save role2 uncomment this and it works user getValidRoles add role1 user getValidRoles add role2 Ebean save user it crashes on the last line with the exception javax persistence PersistenceException org postgresql util PSQLException ERROR insert or update on table userroles violates foreign key constraint userroles roleid fk Detail Key roleid 1463 is not present in table roles userroles is my m t m join table for Users validRoles Here is the relevant logging trans 1006 20 18 20 198 select u userid as c0 from public users u where u userid trans 1006 20 18 20 206 FindById exeMicros 7293 rows 1 type User bind 1462 trans 1007 20 18 20 208 insert into public rol">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-220.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 220 : M2M cascade save ... violates foreign key constraint 
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 220 : M2M cascade save ... violates foreign key constraint  </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">Rob</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">2.4.0</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">21/02/2010</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">21/02/2010</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>user = Ebean.find(User.class, 1462);<br/>Role role1 = new Role();<br/>role1.setName("role1");<br/>Ebean.save(role1);<br/>Role role2 = new Role();<br/>role2.setName("role2");<br/>//Ebean.save(role2); // uncomment this and it works<br/>user.getValidRoles().add(role1);<br/>user.getValidRoles().add(role2);<br/>Ebean.save(user);</p><p>it crashes on the last line with the exception:</p><p>javax.persistence.PersistenceException:<br/>org.postgresql.util.PSQLException: ERROR: insert or update on table<br/>"userroles" violates foreign key constraint "userroles_roleid_fk"<br/> Detail: Key (roleid)=(1463) is not present in table "roles".</p><p>(userroles is my m-t-m join table for Users.validRoles)<br/>Here is the relevant logging:</p><p>trans[1006], 20:18:20.198, select u.userid as c0  from public.users u<br/>where u.userid = ?<br/>trans[1006], 20:18:20.206, FindById exeMicros[7293] rows[1] type[User]<br/>bind[1462]<br/>trans[1007], 20:18:20.208, insert into public.roles (roleid, name)<br/>values (?, ?)<br/>trans[1007], 20:18:20.208, Binding Insert [public.roles]  set[id=1462,<br/>name=role1, ]<br/>trans[1007], 20:18:20.209, Inserted [Role] [1462]<br/>trans[1008], 20:18:20.219, select u.userid as c0         , uv.roleid<br/>as c1, uv.name as c2  from public.users u left outer join userroles<br/>uvz_ on uvz_.userid = u.userid  left outer join public.roles uv on<br/>uv.roleid = uvz_.roleid   where u.userid = ?    order by u.userid<br/>trans[1008], 20:18:20.221, FindMany exeMicros[1835] rows[1:1]<br/>type[User] name[] predicates[u.userid = ?  ] bind[1462]<br/>trans[1009], 20:18:20.222, insert into public.roles (roleid, name)<br/>values (?, ?)<br/>trans[1009], 20:18:20.222, Binding Insert [public.roles]  set[id=1463,<br/>name=role2, ]<br/>trans[1009], 20:18:20.223, Inserted [Role] [1463]<br/>trans[1009], 20:18:20.224, insert into userroles (userid, roleid)<br/>values (?, ?)<br/>trans[1010], 20:18:20.231, InsertSql table[userroles] rows[1]<br/>bind[1462, 1462, ]<br/>trans[1009], 20:18:20.233, insert into userroles (userid, roleid)<br/>values (?, ?)</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
Rob 
21 Feb&nbsp;08:57
</div>
insert into intersection in a different transaction ...
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>The insert in the middle is using trans[1010] and not [1009] ... and this is a BUG !!</p><p>I have a strong suspicion that is the issue here.  I'll have to reproduce to confirm and fix.Note the insert/delete into the intersection table actually uses SqlUpdate internally ... looks like the current transaction is not being picked up for the internal use of SqlUpdate.</p><p>... so that's a bummer :( ... but your thinking is right on!!</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
21 Feb&nbsp;08:59
</div>
Fixed in HEAD
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Fixed in HEAD.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="220">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-220.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="220">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
