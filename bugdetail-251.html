<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: ENHANCEMENT - Better connection pool leak detection ... via stack trace</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="Rob">
<meta name="description" content="I have made a few tweaks to the connection pool leak detection datasource h2 maxConnections 25 datasource h2 capturestacktrace true Put the capturestacktrace true parameter and then the Ebean DataSource will get the stack element array when we get a connection If the pool runs out of connections it will reset itself or you can call the reset manually and at that point busy connections will be checked to see if they are possible connection pools Also when the connection pool is shutdown the information on the busy connections are also dumped It is logged and also send to sys err It is sent to sys err because the loggers stop working early in a JVM shutdown ">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-251.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 251 : ENHANCEMENT - Better connection pool leak detection ... via stack trace
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 251 : ENHANCEMENT - Better connection pool leak detection ... via stack trace </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">Rob</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">2.5.0</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">17/03/2010</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">17/03/2010</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>I have made a few tweaks to the connection pool leak detection.</p><pre class="java">...
datasource.h2.maxConnections=25
datasource.h2.capturestacktrace=true</pre><p>Put the capturestacktrace = true parameter ... and then the Ebean DataSource will get the stack element array when we get a connection.</p><p>If the pool runs out of connections it will reset itself (or you can call the reset manually) ... and at that point busy connections will be checked to see if they are possible connection pools.</p><p>Also when the connection pool is shutdown the information on the busy connections are also dumped.</p><p>It is logged and also send to sys err. It is sent to sys err because the loggers stop working early in a JVM shutdown.</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Mar&nbsp;05:30
</div>
Logged information
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>The logged information is:</p><p>INFO: DataSourcePool [h2] grow pool;  busy[24] size[24] max[25]<br/>17/03/2010 05:17:48 com.avaje.ebeaninternal.server.lib.sql.DataSourcePool reset<br/>INFO: Reseting DataSourcePool [h2]<br/>17/03/2010 05:17:48 com.avaje.ebeaninternal.server.lib.sql.DataSourcePool reset<br/>INFO: Busy Connections:<br/>name[h2.1] startTime[1268803068504] stmt[null] createdBy[com.avaje.tests.query.TestPagingListLoop.createLeak(TestPagingListLoop.java:39)]<br/>name[h2.2] startTime[1268803068506] stmt[null] createdBy[com.avaje.tests.query.TestPagingListLoop.createLeak(TestPagingListLoop.java:39)]</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Mar&nbsp;05:31
</div>
And the stack traces are output: 
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>example:</p><p>17/03/2010 05:17:48 com.avaje.ebeaninternal.server.lib.sql.DataSourcePool closeBusyConnections<br/>WARNING: DataSourcePool closing leaked connection?  name[h2.1] lastUsed[Wed Mar 17 05:17:48 GMT 2010] createdBy[com.avaje.tests.query.TestPagingListLoop.createLeak(TestPagingListLoop.java:39)] lastStmt[null]<br/>17/03/2010 05:17:48 com.avaje.ebeaninternal.server.lib.sql.DataSourcePool logStackElement<br/>WARNING: Possible Leaked Connection:  name[h2.1] stackTrace: [com.avaje.tests.query.TestPagingListLoop.createLeak(TestPagingListLoop.java:39), com.avaje.tests.query.TestPagingListLoop.test(TestPagingListLoop.java:20), sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method), sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39), sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)]<br/>Possible Leaked Connection:  name[h2.1] stackTrace: [com.avaje.tests.query.TestPagingListLoop.createLeak(TestPagingListLoop.java:39), com.avaje.tests.query.TestPagingListLoop.test(TestPagingListLoop.java:20), sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method), sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39), sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)]<br/>17/03/2010 05:17:48 com.avaje.ebeaninternal.server.lib.sql.PooledConnection closeConnectionFully<br/> ...</p><p>So there can be a lot dumped out.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Mar&nbsp;05:33
</div>
So ...
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>So the stack trace points out where the connection was created (and never closed).</p><p>In the example above I have a connection pool leak in:</p><p>com.avaje.tests.query.TestPagingListLoop.createLeak(TestPagingListLoop.java:39)</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Mar&nbsp;05:42
</div>
Fixed in HEAD
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Fixed in HEAD.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="251">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-251.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="251">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
