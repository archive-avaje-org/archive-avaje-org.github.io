<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: Incorrect table alias with Multiple OneToOne on bean</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="Rob">
<meta name="description" content="As per http groups google com group ebean browse thread thread af121ba6e7234849 Hi I have a problem fetching a bean containing other beans here is some code Entity public class Abitazione implements Serializable Id private Integer id OneToMany cascade CascadeType ALL mappedBy abitazione PrivateOwned List pratiche Version int updateCount Entity public class Pratica implements Serializable Id private Integer id ManyToOne optional false private Abitazione abitazione OneToOne cascade CascadeType ALL optional true mappedBy pratica PrivateOwned private ConformitaEdilizia conformita OneToOne cascade CascadeType ALL optional true mappedBy pratica PrivateOwned private ParereIgienicoSanitario parere Version private int updateCount Entity public class ParereIgienicoSanitario implements Serializable I">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-321.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 321 : Incorrect table alias with Multiple OneToOne on bean
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 321 : Incorrect table alias with Multiple OneToOne on bean </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">Rob</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">2.7.0</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">18/09/2010</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">18/09/2010</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>As per <a href="http://groups.google.com/group/ebean/browse_thread/thread/af121ba6e7234849">http://groups.google.com/group/ebean/browse_thread/thread/af121ba6e7234849</a></p><p>Hi, I have a problem fetching a bean containing other beans; here is<br/>some code:</p><p>@Entity<br/>public class Abitazione implements Serializable {<br/>        @Id private Integer id;<br/>        @OneToMany(cascade=CascadeType.ALL, mappedBy="abitazione")<br/>@PrivateOwned List<Pratica> pratiche;<br/>        @Version int updateCount;<br/>        ...</p><p>}</p><p>@Entity<br/>public class Pratica implements Serializable {<br/>        @Id private Integer id;<br/>        @ManyToOne(optional=false) private Abitazione abitazione;<br/>        @OneToOne(cascade=CascadeType.ALL, optional=true, mappedBy="pratica")<br/>@PrivateOwned private ConformitaEdilizia conformita;<br/>        @OneToOne(cascade=CascadeType.ALL, optional=true, mappedBy="pratica")<br/>@PrivateOwned private ParereIgienicoSanitario parere;<br/>        @Version private int updateCount;<br/>        ...</p><p>}</p><p>@Entity<br/>public class ParereIgienicoSanitario implements Serializable {<br/>        @Id private Integer id;<br/>        @OneToOne(optional=false) private Pratica pratica;<br/>        @Version private int updateCount;<br/>        ...</p><p>}</p><p>@Entity<br/>public class ConformitaEdilizia implements Serializable {<br/>        @Id private Integer id;<br/>        @OneToOne(optional=false) private Pratica pratica;<br/>        @Version private int updateCount;<br/>        ...</p><p>}</p><p>So a bean of class Abitazione has a list of beans of class Pratica.<br/>Pratica has one ParereIgienicoSanitario and one ConformitaEdilizia.</p><p>If I try to load a bean of class Abitazione ad read the list of<br/>Pratica:</p><p>abitazione = Ebean.find(idoneitaalloggiativa.model.Abitazione.class,<br/>100);</p><p>for (idoneitaalloggiativa.model.Pratica pratica :<br/>abitazione.getPratiche()) {<br/>System.out.println(pratica);<br/>   System.out.println(pratica.getConformita());<br/>   System.out.println(pratica.getParere());</p><p>}</p><p>I get an error:</p><p>Exception in thread "main" javax.persistence.PersistenceException:<br/>Query threw SQLException:Column "AA.ID" not found; SQL statement:<br/>select a.id c0<br/>        , ap.id c1, ap.update_count c2, ap.abitazione_id c3, apc.id<br/>c4, aa.id c5<br/>from ABITAZIONE a<br/>left outer join PRATICA ap on ap.abitazione_id = a.id<br/>left outer join CONFORMITA apc on apc.pratica_id = ap.id<br/>left outer join PARERE app on app.pratica_id = ap.id<br/>where a.id = ?<br/>order by a.id [42122-140 begin_of_the_skype_highlighting              42122-140      end_of_the_skype_highlighting] Query was:<br/>select a.id c0<br/>        , ap.id c1, ap.update_count c2, ap.abitazione_id c3, apc.id<br/>c4, aa.id c5<br/>from ABITAZIONE a<br/>left outer join PRATICA ap on ap.abitazione_id = a.id<br/>left outer join CONFORMITA apc on apc.pratica_id = ap.id<br/>left outer join PARERE app on app.pratica_id = ap.id<br/>where a.id = ?<br/>order by a.id</p><p>        at<br/>com.avaje.ebeaninternal.server.query.CQueryEngine.findMany(CQueryEngine.java:<br/>204)<br/>        at<br/>com.avaje.ebeaninternal.server.query.DefaultOrmQueryEngine.findMany(DefaultOrmQueryEngine.java:<br/>89)<br/>        at<br/>com.avaje.ebeaninternal.server.core.OrmQueryRequest.findList(OrmQueryRequest.java:<br/>298)<br/>        at<br/>com.avaje.ebeaninternal.server.core.DefaultServer.findList(DefaultServer.java:<br/>1369)<br/>        at<br/>com.avaje.ebeaninternal.server.core.DefaultBeanLoader.loadMany(DefaultBeanLoader.java:<br/>162)<br/>        at<br/>com.avaje.ebeaninternal.server.core.DefaultServer.loadMany(DefaultServer.java:<br/>446)<br/>        at<br/>com.avaje.ebeaninternal.server.loadcontext.DLoadManyContext.loadMany(DLoadManyContext.java:<br/>142)<br/>        at<br/>com.avaje.ebean.common.AbstractBeanCollection.lazyLoadCollection(AbstractBeanCollection.java:<br/>152)<br/>        at com.avaje.ebean.common.BeanList.init(BeanList.java:116)<br/>        at com.avaje.ebean.common.BeanList.iterator(BeanList.java:288)<br/>        at idoneitaalloggiativa.testerror.TestError.main(TestError.java:38)<br/>Caused by: org.h2.jdbc.JdbcSQLException: Column "AA.ID" not found; SQL<br/>statement:<br/>select a.id c0<br/>        , ap.id c1, ap.update_count c2, ap.abitazione_id c3, apc.id<br/>c4, aa.id c5<br/>from ABITAZIONE a<br/>left outer join PRATICA ap on ap.abitazione_id = a.id<br/>left outer join CONFORMITA apc on apc.pratica_id = ap.id<br/>left outer join PARERE app on app.pratica_id = ap.id<br/>where a.id = ?<br/>order by a.id [42122-140 begin_of_the_skype_highlighting              42122-140      end_of_the_skype_highlighting]<br/>        at org.h2.message.DbException.getJdbcSQLException(DbException.java:<br/>327)<br/>        at org.h2.message.DbException.get(DbException.java:167)<br/>        at org.h2.message.DbException.get(DbException.java:144)<br/>        at org.h2.expression.ExpressionColumn.optimize(ExpressionColumn.java:<br/>127)<br/>        at org.h2.expression.Alias.optimize(Alias.java:47)<br/>        at org.h2.command.dml.Select.prepare(Select.java:738)<br/>        at org.h2.command.Parser.prepare(Parser.java:202)<br/>        at org.h2.command.Parser.prepareCommand(Parser.java:214)<br/>        at org.h2.engine.Session.prepareLocal(Session.java:434)<br/>        at org.h2.engine.Session.prepareCommand(Session.java:384)<br/>        at org.h2.jdbc.JdbcConnection.prepareCommand(JdbcConnection.java:<br/>1071)<br/>        at<br/>org.h2.jdbc.JdbcPreparedStatement.<init>(JdbcPreparedStatement.java:<br/>71)<br/>        at org.h2.jdbc.JdbcConnection.prepareStatement(JdbcConnection.java:<br/>234)<br/>        at<br/>com.avaje.ebeaninternal.server.lib.sql.PooledConnection.prepareStatement(PooledConnection.java:<br/>426)<br/>        at<br/>com.avaje.ebeaninternal.server.lib.sql.PooledConnection.prepareStatement(PooledConnection.java:<br/>396)<br/>        at<br/>com.avaje.ebeaninternal.server.query.CQuery.prepareBindExecuteQuery(CQuery.java:<br/>396)<br/>        at<br/>com.avaje.ebeaninternal.server.query.CQueryEngine.findMany(CQueryEngine.java:<br/>162)<br/>        ... 10 more</p><p>Ebean log is:</p><p>1-ago-2010 23.52.09 com.avaje.ebean.config.PropertyMapLoader load<br/>GRAVE: ebean.properties not found<br/>1-ago-2010 23.52.09<br/>com.avaje.ebeaninternal.server.lib.sql.DataSourcePool initialise<br/>INFO: DataSourcePool [certificazioni] autoCommit[false]<br/>transIsolation[READ_COMMITTED] min[2] max[20]<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.core.DefaultServerFactory<br/>setDatabasePlatform<br/>INFO: DatabasePlatform name:certificazioni platform:h2<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.subclass.SubClassManager$1 run<br/>INFO: SubClassFactory parent ClassLoader [sun.misc.Launcher<br/>$AppClassLoader]<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.type.DefaultTypeManager<br/>initialiseJodaTypes<br/>INFO: Registering Joda data types<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.resource.ResourceManagerFactory<br/>createFileSource<br/>INFO: ResourceManager initialised: type[file] [C:\Documents and<br/>Settings\claudio\Documenti\lavoro\workspace\idoneitaalloggiativa_old<br/>\WebContent\WEB-INF]<br/>1-ago-2010 23.52.10 com.avaje.ebeaninternal.server.deploy.DeployOrmXml<br/>findAllOrmXml<br/>INFO: No deployment xml (orm.xml etc) was loaded.<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.deploy.BeanDescriptorManager logStatus<br/>INFO: Entities enhanced[4] subclassed[0]<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.transaction.TransactionLogManager<br/><init><br/>INFO: Transaction logs in: logs<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.autofetch.AutoFetchManagerFactory<br/>deserializeAutoFetch<br/>INFO: AutoFetch deserialized from file [C:\Documents and Settings<br/>\claudio\Documenti\lavoro\workspace\idoneitaalloggiativa_old\WebContent<br/>\WEB-INF\.ebean.certificazioni.autofetch]<br/>1-ago-2010 23.52.10<br/>com.avaje.ebeaninternal.server.autofetch.DefaultAutoFetchManagerLogging<br/>logToJavaLogger<br/>INFO: AutoFetch queryTuning[true] profiling[true]<br/>mode[DEFAULT_ONIFEMPTY]  profiling rate[0.05] min[1] base[10]<br/>1-ago-2010 23.52.10 com.avaje.ebean.Ebean <clinit><br/>INFO: Ebean Version[2.6.1] Java Version[1.6.0_18]</p><p>If I leave only one OneToOne association in Pratica all works<br/>properly.<br/>Seems like an error generating the column alias of the OneToOne<br/>properties of Pratica. Or perhaps my mapping is not correct.</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
Rob 
18 Sep&nbsp;09:48
</div>
Uploaded test case
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Claudio uploaded a test case and I have reproduced this issue.</p><p>Definately a bug.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
18 Sep&nbsp;09:55
</div>
Fixed in HEAD
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>The issue was with DefaultDbSqlContext.<br/>With multiple OneToOne relationship at the same level in the object graph the current prefix was being lost. Used a stack to push n pop the currentPrefix.</p><p>Fixed in HEAD.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="321">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-321.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="321">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
