<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: Performance generated SQL to lazy load of collection</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="Rob">
<meta name="description" content="Hello Hello I have Case with child collection ScheduledAssignment The following query ExecutionResources getEbeanServer find Case class fetch scheduledAssignments where eq scheduleDay id 4205 findList Produces this SQL select t0 caseid as c0 t0 externalId as c1 from public cases t0 join public locations t2 on t2 locationid t0 roomlocationid left outer join public scheduledassignments t1 on t1 caseId t0 caseid left outer join public roles t3 on t3 roleid t1 roleid where t0 scheduledayid order by t0 caseid Since any given Case may or may not have children the left join is appropriate If I add a FetchConfig ExecutionResources getEbeanServer find Case class fetch scheduledAssignments new FetchConfig query where eq scheduleDay id 4205 findList I get 2 queries select t0 caseid as c0 t0 externalI">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-410.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 410 : Performance generated SQL to lazy load of collection
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 410 : Performance generated SQL to lazy load of collection </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">Rob</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">3.3.1</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">06/07/2012</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">06/07/2012</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>Hello,</p><p>Hello, </p><p>I have "Case" with child collection "ScheduledAssignment". The following query:</p><p>ExecutionResources.getEbeanServer().find(Case.class)<br/>.fetch("scheduledAssignments")<br/>.where()<br/>.eq("scheduleDay.id", 4205)<br/>.findList();</p><p>Produces this SQL:</p><p><sql summary='Case +many:scheduledAssignments' ><br/>select t0.caseid as c0, t0.externalId as c1, ...<br/>from public.cases t0<br/>join public.locations t2 on t2.locationid = t0.roomlocationid <br/>left outer join public.scheduledassignments t1 on t1.caseId = t0.caseid <br/>left outer join public.roles t3 on t3.roleid = t1.roleid  <br/>where t0.scheduledayid = ?  <br/>order by t0.caseid<br/></sql></p><p>Since any given Case may or may not have children, the left join is appropriate. If I add a FetchConfig:</p><p>ExecutionResources.getEbeanServer().find(Case.class)<br/>.fetch("scheduledAssignments", new FetchConfig().query())<br/>.where()<br/>.eq("scheduleDay.id", 4205)<br/>.findList();</p><p>I get 2 queries:</p><p><sql summary='Case' ><br/>select t0.caseid as c0, t0.externalId as c1, ...<br/>from public.cases t0<br/>join public.locations t1 on t1.locationid = t0.roomlocationid  <br/>where t0.scheduledayid = ? <br/></sql></p><p><sql mode='+query' summary='Case +many:scheduledAssignments' load='path:scheduledAssignments batch:100 actual:85' ><br/>select t0.caseid as c0, t1.scheduledassignmentid as c1, ...<br/>from public.cases t0<br/>left outer join public.scheduledassignments t1 on t1.caseId = t0.caseid <br/>left outer join public.roles t2 on t2.roleid = t1.roleid  <br/>where t0.caseid in (?,?,?,?,? ...)  <br/>order by t0.caseid<br/></sql></p><p>Note that the second query selects from cases and left joins scheduledassignments. This is unexpected. It seems it should select from scheduledassignments where scheduledassignments.caseid in (?, ? ...) (or simply inner join cases to scheduledassignments). The left joins here are significant in terms of degrading performance. Is there some way to tune this to get inner joins instead? Or is there some architectural reason to require at least one record per case?</p><p>Thanks.</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
Rob 
06 Jul&nbsp;03:51
</div>
Yup, the generated SQL needs improvement
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>>>  The left joins here are significant in terms of degrading performance. Is there some way to tune this to get inner joins instead?</p><p>So the reason it is like this is because I was lazy and didn't optimize this case (and forgot  / didn't get back to this issue). </p><p>Changing to use inner joins is one option but I believe the better one would to not include the 'root table' in the query at all (table public.cases t0 in the example below) and instead select from the 'many':</p><p> select t0.caseId ... from public.scheduledassignments t0 ...</p><p></p><p><br/>>> Or is there some architectural reason to require at least one record per case?</p><p>No, there is no architectural / good reason for this. Note that the current implementation is just a partial object query where only the id of the root object is selected so it was no extra work at the time.</p><p>Yes, we would need to make sure we check for the case where there are no detail rows. It would be a small change to check the collections for this case and mark the collection as lazy loaded with 0 entries.</p><p>I'll log a bug for this.</p><p></p><p>Cheers, Rob.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="410">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-410.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="410">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
