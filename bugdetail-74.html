<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: Classpath search not working in resin 2.1.17 - No entities found</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="Rob">
<meta name="description" content="From Anton I ve downloaded your sources and compiled them myself to see if I could narrow it down and I did The problem lies in the class com avaje ebean server util ClassPathSearch in partical this method private void initClassPaths try classPaths java net URLClassLoader classLoader getURLs catch ClassCastException e classPaths System getProperty java class path split File pathSeparator if logger isLoggable Level FINER String msg Classpath Arrays toString classPaths logger finer msg The classloader resin 2 1 17 is giving us is the com caucho java CompilingClassLoader which in particular is not an instance of java net URLClassLoader so you get the classcastexception your code is catching But the system property java class path is not filled with the web application jars classes so that s t">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-74.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 74 : Classpath search not working in resin 2.1.17 - No entities found
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 74 : Classpath search not working in resin 2.1.17 - No entities found </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">Rob</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">1.0.3</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">19/02/2009</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">19/02/2009</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>From Anton...</p><p>I've downloaded your sources and compiled them myself to see if I could narrow it down... and I did!</p><p>The problem lies in the class com.avaje.ebean.server.util.ClassPathSearch in partical this method:<br/>    private void initClassPaths() {<br/>        try {<br/>            classPaths = ((java.net.URLClassLoader) classLoader).getURLs();<br/>        } catch (ClassCastException e) {<br/>            classPaths = System.getProperty("java.class.path", "").split(File.pathSeparator);<br/>        }<br/>        if (logger.isLoggable(Level.FINER)) {<br/>            String msg = "Classpath " + Arrays.toString(classPaths);<br/>            logger.finer(msg);<br/>        }<br/>    }</p><p>The classloader resin 2.1.17 is giving us is the com.caucho.java.CompilingClassLoader which in particular is not an instance of java.net.URLClassLoader, so you get the classcastexception your code is catching. But the system-property java.class.path is not filled with the web-application jars/classes, so that's the reason for not running under resin 2.1.17. Resin 3.x gives you the option to specify classloaders via their config-files, so it can probably work without adjustments for resin 3.x, but I need resin 2.1.17 for some applications we have in production....</p><p>I've tried searching for a general way besides getUrls() to get all the resource-paths from a classloader, but I didn't find anything alike. So for my application I've hacked the method like this:<br/>    private void initClassPaths() {<br/>        try {<br/>            classPaths = ((java.net.URLClassLoader) classLoader).getURLs();<br/>        } catch (ClassCastException e) {<br/>            try {<br/>                classPaths = classLoader.getClass().getMethod("getClassPath").invoke(classLoader).toString().split(File.pathSeparator);<br/>            } catch (Throwable ex) {<br/>                classPaths = System.getProperty("java.class.path", "").split(File.pathSeparator);<br/>            }<br/>        }<br/>        if (logger.isLoggable(Level.FINER)) {<br/>          String msg = "Classpath " + Arrays.toString(classPaths);<br/>            logger.finer(msg);<br/>        }<br/>    }<br/>This works because com.caucho.java.CompilingClassLoader implements the interface com.caucho.util.CauchoClassLoader which amongst others specifies this method:<br/> public String getClassPath();</p><p>Do you know any general ways to retrieve all resource-paths from a classloader? That whould certainly make my hack unneccesary....</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
Rob 
19 Feb&nbsp;10:01
</div>
Make the class path reader pluggable
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>There is no general way to get the class paths (that I know of)... </p><p>The solution I have come up with is to make the implementation that determines the class paths pluggable. The interface is ClassPathReader and if the default implementation (DefaultClassPathReader) does not do the trick you can write your own and specify Ebean to use it via ebean.properties.</p><p>#<br/># (in ebean.properties)<br/># Specify your own ClassPathReader implementation<br/>#<br/>ebean.classpathreader=com.banana.MyClassPathReaderImplementation</p><p></p><p>public interface ClassPathReader {</p><p>	/**<br/>	 * Return the paths in the classpath to search for entity beans etc.<br/>	 * <p><br/>	 * This will typically return a URL[] or String[] of the entries in the<br/>	 * class path.<br/>	 * </p><br/>	 */<br/>	public Object[] readPath(ClassLoader classLoader);<br/>}</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
19 Feb&nbsp;10:04
</div>
Fixed in v1.0.3
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>I have incorporated this into v1.0.3.</p><p>Note: The majority of people will find their ClassLoader extends URLClassLoader and the default implementation will be fine.</p><p>Also note that I've added some more warnings logged when there appears to be an issue such as no classpaths etc so hopefully that extra detail will make things clearer when there is a classpath searching issue.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="74">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-74.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="74">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
