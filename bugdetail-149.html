<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: failing test TestSqlBasedEntity</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="imario">
<meta name="description" content="Hi The newly commited test com avaje tests report TestSqlBasedEntity shows that using Sql based entities as described in the documentation with ReportTopic does not work when using a default sql The reason is that Sql generates raw sql but in DeployBeanDescriptor isSqlSelectBased it is checked for a NamedSql with name default instead of RawSql ">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-149.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 149 : failing test TestSqlBasedEntity
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 149 : failing test TestSqlBasedEntity </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">imario</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">2.1.0</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">09/09/2009</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">09/09/2009</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>Hi!</p><p>The newly commited test com.avaje.tests.report.TestSqlBasedEntity shows that using Sql based entities as described in the documentation with "ReportTopic" does not work when using a default sql.</p><p>The reason is, that @Sql generates raw sql but in DeployBeanDescriptor.isSqlSelectBased it is checked for a _NamedSql_ with name "default" instead of RawSql.</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
imario 
09 Sep&nbsp;11:14
</div>
findings
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>It seems the rawSqlMetas in DeployBeanDescriptor are feed into the namedQuery collections in BeanDescriptorManager.deploy (call to readRawSqlQueries)</p><p>However, ebean needs to know the fact that the bean is a report bean earlier (don't know exactly where).</p><p><br/>Applying this patch will fix the test:<br/>Index: ../opsxcited_3rdpary/ebean/core/src/main/java/com/avaje/ebean/server/deploy/meta/DeployBeanDescriptor.java<br/>===================================================================<br/>--- ../opsxcited_3rdpary/ebean/core/src/main/java/com/avaje/ebean/server/deploy/meta/DeployBeanDescriptor.java	(revision 463)<br/>+++ ../opsxcited_3rdpary/ebean/core/src/main/java/com/avaje/ebean/server/deploy/meta/DeployBeanDescriptor.java	Wed Sep 09 13:11:14 CEST 2009<br/>@@ -269,6 +269,11 @@<br/> 		if (defaultQuery != null) {<br/> 			return defaultQuery.isSqlSelect();<br/> 		}<br/>+		RawSqlMeta rawSql = rawSqlMetas.get("default");<br/>+		if (rawSql != null) {<br/>+			return true;<br/>+		}<br/>+<br/> 		return false;<br/> 	}</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
09 Sep&nbsp;12:10
</div>
Yes...
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Looking at BeanDescriptorManager... lines 228 - 230</p><p>readEntityDeploymentAssociations();<br/>...<br/>readRawSqlQueries();</p><p><br/>... the readRawSqlQueries is called after the first check for isSqlSelect() which is setting the base table to null (as it will default from the naming convention - so must be set to null for entities based on raw sql).</p><p>Yes, your patch works and fixes the issue.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
09 Sep&nbsp;12:22
</div>
Ok, I'm happy...
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>I was just wondering about other options instead of the patch above - but I think the patch above is a good solution.</p><p>Specifically, the 'parsing' of RawSqlMeta ... occurs late (too late for the initial check to see if the entity is based on sql). I want to keep this because it means that we can (if we want) allow users to programmatically use raw sql queries.</p><p>That is, at the moment users need to use the @Sql annotations... and instead we can provide this as API that can be used at runtime. The raw sql and column mapping can be parsed at runtime... giving users programmatic control over the SQL and column mapping.</p><p>I think we still want to do that, so I'm happy with the patch... and don't think we can improve on it really.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
09 Sep&nbsp;12:27
</div>
Committed to HEAD
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>I have committed the patch into HEAD.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="149">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-149.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="149">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
