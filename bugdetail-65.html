<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict //EN">
<html>
<head>
<title>Bug: BeanPropertyAssocOne not initialized</title>
<link rel="shortcut icon" href="/image/favicon.ico" >
<link rel="stylesheet" type="text/css" href="/static/v2style.css" >
<!--
<link rel="stylesheet" type="text/css" href="/css/100/basestyle|syntaxhighlighter" >
-->

<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="/doc/ie.css" media="screen">
<![endif]-->


<meta name="Author" content="imario">
<meta name="description" content="For some reasons it seems the BeanPropertyAssocOne initialize has not been called and so subsequent access to the targetDescriptor results in an NullPointerException I am pretty sure this is not the right patch but for me it started to work afterwards Still as I wrote this might just be a hack I am still learning the in depths of this framework Index ebean src com avaje ebean server deploy BeanPropertyAssocMany java ebean src com avaje ebean server deploy BeanPropertyAssocMany java revision 127 ebean src com avaje ebean server deploy BeanPropertyAssocMany java Sat Feb 14 10 37 23 CET 2009 310 6 310 11 if uids length 1 uids 0 isEmbedded BeanPropertyAssocOne one BeanPropertyAssocOne uids 0 if one getTargetDescriptor null I ll consider this as a hack one initialise BeanDescriptor targetDesc o">

<script type="text/javascript" src="/doc/jslib.js" ></script>
<!--
<script type="text/javascript" src="/jsl/jquery|jquery.corner|mygoo|app|shCore|shBrushJava|shBrushProperty|shBrushSql" ></script>
-->

<script type="text/javascript">
 $(document).ready(function(){
	$(".topic").corner("12px");
	$("a.action").corner("8px hover");
	$("div.example").corner("5px");
	$(".reqrlogin").hide();

	//dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');

 });
</script>

<!-- component('cn=app.comp.LoginEnable') -->




</head>

<body>
<form action='/bugdetail-65.html' method="post" id="GLOBAL_ACTION">
<input type='hidden' name='_WOGA_CONTROLLER' >
<input type='hidden' name='_WOGA_METHOD' >
<input type='hidden' name='_WOGA_PARAM' >
<input type='hidden' name='_WOGA_RENDER' >
<a id="top"></a>
<div id="headwrap">
<div id="headmax">
<div id="menuuser">
<!-- component('cn=app.comp.UserStatus') -->
</div>
<img id="logo" src="/image/logo-avaje.gif" width="127" height="50" alt="avaje logo">
<div style="clear:both;"></div>
</div>
</div><!-- end of headwrap -->

<div id="head2wrap">
<div id="head2max">
<table summary="layout">
<tr>
<td align="center">
<div id="menutab" style="">
<a id="m0" href="/" class="popmenu"><span>home</span></a>
<a id="m1" href="/ebean/documentation.html" class="popmenu"><span>documentation</span></a>
<a id="m4" href="/download.html" class="popmenu"><span>downloads</span></a>
<a id="m6" href="http://groups.google.com/group/ebean" class="popmenu"><span>google group</span></a>
<a id="m2" href="/forum.html" class="popmenu"><span>forums<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m3" href="/bug.html" class="popmenu"><span>bugs<img src="/image/menuDownH6_3.gif" width="11" height="11" alt=""></span></a>
<a id="m5" href="/feedback.html" class="popmenu"><span>feedback</span></a>
</div>
</td>
</tr>
</table>
</div>
</div>

<div id="bodywrap">
<div id="bodymax">
<div id="content">
<div id="pageBody">
<div id="breadcrumb">
&nbsp;
</div>






<div class="breadcrumb">
<img src="/image/smallhome.gif"> <a href="index.html">Home</a> &raquo; <a href="bug.html">Bugs</a> &raquo; BUG 65 : BeanPropertyAssocOne not initialized
</div>


<!-- bug header info -->




<div id="app.comp.BugDetailComp">

<div class="pageactions">
<!--
<input type="button" style="width:12em;" class="btn requser" value="Add Comment" onclick="j('#bugDetailForm').show();j('#f_title').focus();">
<input type="button" style="width:12em;" class="btn requser" value="Create a new Bug" onclick="gotoURL('bugnew.html');">
-->
</div>

<table class="formlayout">
<tr>
<td colspan="6" class="heading">&nbsp;<span class="xheading">Bug 65 : BeanPropertyAssocOne not initialized </span></td>
</tr>
<tr>
<td width="15%" class="label">Priority&nbsp;</td><td><div class="fieldmargin"><span class="field">High</span></div></td>
<td class="label">Reported Version&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Logged By&nbsp;</td><td><div class="fieldmargin"><span class="field">imario</span></div></td>
</tr>

<tr>
<td class="label">Status&nbsp;</td><td><div class="fieldmargin"><span class="field">Fixed</span></div></td>
<td class="label">Fixed Version&nbsp;</td><td><div class="fieldmargin"><span class="field">1.0.3</span></div></td>
<td class="label">Assigned To&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
</tr>

<tr>
<td class="label">Product&nbsp;</td><td><div class="fieldmargin"><span class="field">Ebean - core</span></div></td>
<td class="label">Duplicate Of&nbsp;</td><td><div class="fieldmargin"><span class="field">&nbsp;</span></div></td>
<td class="label">Created&nbsp;</td><td><div class="fieldmargin"><span class="field">14/02/2009</span></div></td>
</tr>

<tr>
<td class="label">Updated&nbsp;</td><td><div class="fieldmargin"><span class="field">14/02/2009</span></div></td>
<td class="label">Type&nbsp;</td><td><div class="fieldmargin"><span class="field">Bug</span></div></td>
<td class="label">&nbsp;</td><td></td>
</tr>

<tr>
<td class="label">Attachments&nbsp;</td>
<td colspan="5">
<div class="attachments">
<div class="fieldmargin">
<span class="field" style="width:100%;">
No attachments</span>
</div>
</div>
</td>
</tr>

<tr>
<td colspan="6"><div class="fieldmargin"><span class="field"><p>For some reasons it seems the BeanPropertyAssocOne.initialize() has not been called and so subsequent access to the targetDescriptor results in an NullPointerException.</p><p>I am pretty sure this is not the right patch, but for me it started to work afterwards. Still, as I wrote this might just be a hack.<br/>I am still learning the "in depths" of this framework.</p><p>Index: ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssocMany.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssocMany.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssocMany.java	Sat Feb 14 10:37:23 CET 2009<br/>@@ -310,6 +310,11 @@<br/> 		if (uids.length == 1 && uids[0].isEmbedded()) {<br/> <br/> 			BeanPropertyAssocOne one = (BeanPropertyAssocOne) uids[0];<br/>+            if (one.getTargetDescriptor() == null)<br/>+            {<br/>+                // I'll consider this as a hack ...<br/>+                one.initialise();<br/>+            }<br/> 			BeanDescriptor targetDesc = one.getTargetDescriptor();<br/> 			BeanProperty[] emIds = targetDesc.propertiesBaseScalar();<br/> 			for (int i = 0; i < emIds.length; i++) {<br/>Index: ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssoc.java<br/>===================================================================<br/>--- ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssoc.java	(revision 127)<br/>+++ ../ebean/src/com/avaje/ebean/server/deploy/BeanPropertyAssoc.java	Sat Feb 14 12:40:30 CET 2009<br/>@@ -264,6 +264,11 @@<br/> 			} else {<br/> 				// embedded id<br/> 				BeanPropertyAssocOne embProp = (BeanPropertyAssocOne)props[0];<br/>+                if (embProp.getTargetDescriptor() == null)<br/>+                {<br/>+                    // I'll consider this as a hack ...<br/>+                    embProp.initialise();<br/>+                }<br/> 				BeanProperty[] embBaseProps = embProp.getTargetDescriptor().propertiesBaseScalar();<br/> 				ImportedIdSimple[] scalars = createImportedList(owner, cols, embBaseProps);</p></span></div></td>
</tr>

<tr>
<td colspan="6">&nbsp;</td>
</tr>
</table>

<div class="bugdetail-head">
<div style="float:right">
Rob 
16 Feb&nbsp;08:17
</div>
The issue here...
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>The issue here is:<br/>- You have a entity bean with an EmbeddedId property<br/>- It also has a OneToMany property</p><p>When BeanDescriptor initialises its properties ... it needs to make sure that it initialises the EmbeddedId property *BEFORE* the OneToMany property.</p><p>At the moment BeanDescriptor does not garuntee the order... and so you can get the NPE if the OneToMany property initialises before the EmbeddedId property.</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
16 Feb&nbsp;09:26
</div>
I can reproduce
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>It looks to be as I thought. I can reproduce the NPE.</p><p>Exception in thread "main" java.lang.ExceptionInInitializerError<br/>	at main.FindCMaster.main(FindCMaster.java:14)<br/>Caused by: java.lang.NullPointerException<br/>	at com.avaje.ebean.server.deploy.BeanPropertyAssocMany.createExported(BeanPropertyAssocMany.java:314)<br/>	at com.avaje.ebean.server.deploy.BeanPropertyAssocMany.initialise(BeanPropertyAssocMany.java:148)</p><p>The order of the properties is maintained so if you put the @EmbeddedId property AFTER the @OneToMany property in the java source code you will get this error - and moving the @EmbeddedId property above the @OneToMany in the java source code will get around this issue (you won't get the NPE).</p><p>@Entity<br/>@Table(name="con_master")<br/>public class CMaster {</p><p>	String dcol;</p><p>	@OneToMany(mappedBy="master")<br/>	List<CDetail> details;</p><p>	@EmbeddedId<br/>	CMasterId id;</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
16 Feb&nbsp;09:29
</div>
And the fix
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>And the fix is to The BeanDescriptor initialise() method:</p><p>		<br/>		// always initialise the Id properties first<br/>		BeanProperty[] idProps = propertiesId();<br/>		for (int i = 0; i < idProps.length; i++) {<br/>			idProps[i].initialise();<br/>		}</p><p>		// now initialise all the non-id properties<br/>		Iterator<BeanProperty> it = propertiesAll();<br/>		while (it.hasNext()) {<br/>			BeanProperty prop = it.next();<br/>			//prop.initialise();<br/>			if (!prop.isId()){<br/>				prop.initialise();<br/>			}<br/>		}</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
16 Feb&nbsp;09:31
</div>
Fixed in v1.0.3
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Fixed in v1.0.3</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Feb&nbsp;11:12
</div>
Actually...
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>In testing with Bug66 etc ... this fix needed to change (as it didn't take into account imported properties).</p><p>So, the fix is now a 2 phase initialisation of the entity beans ... 1st phase initialises the ID properties and the second phase initialises the rest (including all the associated properties which need the imported and exported properties to already be initialised).</p>
</div>
<p></p>
<div class="bugdetail-head">
<div style="float:right">
Rob 
17 Feb&nbsp;11:12
</div>
Still fixed in v1.0.3
</div>
<div class="bugdetail-foot" style="clear:both;">
<p>Just to be clear - still fixed in v1.0.3 though.</p>
</div>
<p></p>

<input type="hidden" name="f_bugid" value="65">


</div>






<div id="bugDetailForm" style="display:none;">

<div id="app.comp.BugDetailAddComp">

<h4>Add detail to this bug</h4>
<table>
<tr>
<td class="label" style="width:8em;"><span class="mandatory">*</span>Summary:</td>
<td><input class="txt wide90" type="text" id="f_title" name="f_title" value=""></td>
</tr>
<tr>
<td class="label" valign="top"><span class="mandatory">*</span>Details:</td>
<td><textarea class="wide90" name="f_body" rows="10" cols="30"></textarea></td>
</tr>

<tr>
<td class="label"></td>
<td>
&nbsp;
</td>
</tr>

</table>
<div class="buttons">
<input type="button" class="btn" value="Save" accesskey="s" onclick="woPost('app.comp.BugDetailAddComp','doPost');" >
<input type="button" class="btn" value="Cancel" accesskey="c" onclick="j('#bugDetailForm').hide();">
</div>

</div>

</div>
</div>
</div>
</div><!-- end of bodywrap -->

<div id="footwrap">
<div id="footmax">
<div id="foot">
<a href="/">home</a> | <a href="#top">back to top</a>
</div>
</div>
</div><!-- end of footwrap -->

<!-- layers -->
<div id="m1popxxx" class="popmenuchild">
<a href="/ebean/introduction.html">Introduction</a>
<a href="/doc/ebean-userguide.pdf">User Guide (pdf)</a>
<a href="/configure.html">Install/Configure</a>
<a href="/static/javadoc/pub/index.html">Public JavaDoc</a>
<a href="/whitepaper.html">Whitepapers</a>
</div>

<div id="m2pop" class="popmenuchild">
<a href="/forumdetail-1.html">General</a>
<a href="/forumdetail-2.html">Database Specific</a>
<a href="/forumdetail-3.html">Byte Code</a>
<a href="/forumdetail-4.html">Deployment Annotations</a>
<a href="/forumdetail-5.html">Features</a>
</div>

<div id="m3pop" class="popmenuchild">
<a href="/bug.html">Top Bugs</a>
<a href="/enh.html">Top Enhancements</a>
</div>


<div id="woResponse">woResponse</div>

</form>

<div id="attachmentUpload" class="popdialog">
<form action='/bugdetail-65.html' method="post" id="UPLOAD" enctype="multipart/form-data">
<input type="hidden" name="f_bugid" value="65">
<input type="hidden" name="WO_HANDLER" value="app.comp.BugAttachmentUploadHandler">
<h4>Upload a file</h4>
<p><input type='file' name='f_file' ></p>
<div class="buttons">
<input type='submit' name='_upload' value="Upload" > <input type='button' value='Cancel' onclick="popdialog.hide();">
</div>
</form>
</div>

<div id="woFocusDelay"></div>
</body>
</html>
